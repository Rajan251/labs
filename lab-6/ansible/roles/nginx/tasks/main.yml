---
# ============================================================================
# Nginx Role - Main Tasks
# ============================================================================
# This role installs and configures Nginx web server
# ============================================================================

- name: Install Nginx
  apt:
    name: nginx
    state: present
    update_cache: yes
  tags:
    - nginx
    - packages

- name: Create web root directory
  file:
    path: "{{ nginx_root }}"
    state: directory
    owner: www-data
    group: www-data
    mode: '0755'
  tags:
    - nginx

- name: Deploy index.html
  copy:
    dest: "{{ nginx_root }}/index.html"
    content: |
      <!DOCTYPE html>
      <html>
      <head>
          <title>Welcome to {{ nginx_server_name }}</title>
          <style>
              body {
                  font-family: Arial, sans-serif;
                  margin: 50px;
                  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                  color: white;
              }
              .container {
                  background: rgba(255, 255, 255, 0.1);
                  padding: 40px;
                  border-radius: 10px;
                  backdrop-filter: blur(10px);
              }
              h1 { font-size: 3em; margin-bottom: 20px; }
              p { font-size: 1.2em; }
              .info { background: rgba(0, 0, 0, 0.2); padding: 20px; border-radius: 5px; margin-top: 20px; }
          </style>
      </head>
      <body>
          <div class="container">
              <h1>ðŸš€ Server Configured Successfully!</h1>
              <p>This server was provisioned with <strong>Terraform</strong> and configured with <strong>Ansible</strong>.</p>
              <div class="info">
                  <p><strong>Hostname:</strong> {{ inventory_hostname }}</p>
                  <p><strong>Server:</strong> Nginx {{ nginx_version | default('latest') }}</p>
                  <p><strong>Environment:</strong> {{ environment | default('production') }}</p>
              </div>
          </div>
      </body>
      </html>
    owner: www-data
    group: www-data
    mode: '0644'
  tags:
    - nginx

- name: Copy Nginx main configuration
  template:
    src: nginx.conf.j2
    dest: /etc/nginx/nginx.conf
    owner: root
    group: root
    mode: '0644'
    validate: 'nginx -t -c %s'
  notify: Restart Nginx
  tags:
    - nginx
    - config

- name: Copy Nginx site configuration
  template:
    src: site.conf.j2
    dest: /etc/nginx/sites-available/default
    owner: root
    group: root
    mode: '0644'
    validate: 'nginx -t -c /etc/nginx/nginx.conf'
  notify: Reload Nginx
  tags:
    - nginx
    - config

- name: Enable site configuration
  file:
    src: /etc/nginx/sites-available/default
    dest: /etc/nginx/sites-enabled/default
    state: link
  notify: Reload Nginx
  tags:
    - nginx

- name: Remove default Nginx welcome page
  file:
    path: /var/www/html/index.nginx-debian.html
    state: absent
  tags:
    - nginx

- name: Ensure Nginx is started and enabled
  service:
    name: nginx
    state: started
    enabled: yes
  tags:
    - nginx

- name: Allow Nginx through UFW firewall
  ufw:
    rule: allow
    name: 'Nginx Full'
  tags:
    - nginx
    - firewall

- name: Verify Nginx is responding
  uri:
    url: "http://localhost"
    status_code: 200
  register: nginx_check
  retries: 3
  delay: 5
  until: nginx_check.status == 200
  tags:
    - nginx
    - verify

- name: Display Nginx status
  debug:
    msg: "Nginx is running and responding on {{ inventory_hostname }}"
  tags:
    - nginx
