# Ansible Configuration Management Guide

## Table of Contents
- [Overview](#overview)
- [Prerequisites](#prerequisites)
- [Ansible Directory Structure](#ansible-directory-structure)
- [Configuration Files Explained](#configuration-files-explained)
- [Ansible Roles](#ansible-roles)
- [Playbook Execution](#playbook-execution)
- [Variables and Inventory](#variables-and-inventory)
- [Troubleshooting](#troubleshooting)

---

## Overview

This guide explains how to use Ansible to configure servers provisioned by Terraform. Ansible will install and configure:

- **Common**: System updates, users, firewall, base tools
- **Nginx**: Web server with virtual hosts
- **Docker**: Container runtime
- **Kubernetes Tools**: kubectl, helm, kubeadm

---

## Prerequisites

### 1. Install Ansible

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install -y ansible

# Using pip (recommended for latest version)
pip3 install ansible

# Verify installation
ansible --version
```

### 2. Install Required Collections

```bash
# Install community collections
ansible-galaxy collection install community.general
ansible-galaxy collection install ansible.posix
```

### 3. Verify Inventory

```bash
# Check that Terraform generated the inventory
cat inventory/hosts.ini

# Test connectivity
ansible all -i inventory/hosts.ini -m ping
```

---

## Ansible Directory Structure

```
ansible/
├── ansible.cfg                 # Ansible configuration
├── setup.yml                   # Main playbook
├── inventory/
│   ├── hosts.ini              # Generated by Terraform
│   ├── hosts.ini.example      # Static inventory example
│   └── aws_ec2.yml            # Dynamic inventory plugin config
├── roles/
│   ├── common/                # Common system configuration
│   │   ├── tasks/
│   │   │   └── main.yml
│   │   ├── handlers/
│   │   │   └── main.yml
│   │   ├── templates/
│   │   ├── files/
│   │   └── defaults/
│   │       └── main.yml
│   ├── nginx/                 # Nginx web server
│   │   ├── tasks/
│   │   │   └── main.yml
│   │   ├── handlers/
│   │   │   └── main.yml
│   │   ├── templates/
│   │   │   └── nginx.conf.j2
│   │   └── defaults/
│   │       └── main.yml
│   ├── docker/                # Docker installation
│   │   ├── tasks/
│   │   │   └── main.yml
│   │   ├── handlers/
│   │   │   └── main.yml
│   │   └── defaults/
│   │       └── main.yml
│   └── k8s-tools/            # Kubernetes tools
│       ├── tasks/
│       │   └── main.yml
│       └── defaults/
│           └── main.yml
├── group_vars/
│   ├── all.yml               # Variables for all hosts
│   └── webservers.yml        # Variables for web servers
└── host_vars/
    └── terraform-web-1.yml   # Variables for specific host
```

---

## Configuration Files Explained

### ansible.cfg

Main Ansible configuration file:

```ini
[defaults]
# Inventory file location
inventory = ./inventory/hosts.ini

# Disable host key checking (for new instances)
host_key_checking = False

# Number of parallel processes
forks = 10

# SSH timeout
timeout = 30

# Roles path
roles_path = ./roles

# Retry files location
retry_files_enabled = False

# Display settings
stdout_callback = yaml
bin_ansible_callbacks = True

[ssh_connection]
# SSH arguments
ssh_args = -o ControlMaster=auto -o ControlPersist=60s -o StrictHostKeyChecking=no

# Pipelining for performance
pipelining = True
```

**Key Settings:**
- `host_key_checking = False`: Allows connection to new instances without manual SSH key acceptance
- `forks = 10`: Run tasks on 10 hosts in parallel
- `pipelining = True`: Improves performance by reducing SSH operations

### setup.yml (Main Playbook)

The main playbook that orchestrates all configuration:

```yaml
---
- name: Configure all servers with common setup
  hosts: all
  become: yes
  roles:
    - common

- name: Configure web servers
  hosts: webservers
  become: yes
  roles:
    - nginx

- name: Configure application servers
  hosts: appservers
  become: yes
  roles:
    - docker
    - k8s-tools
```

**Structure:**
- **Play 1**: Runs `common` role on all hosts
- **Play 2**: Runs `nginx` role on web servers only
- **Play 3**: Runs `docker` and `k8s-tools` on app servers

---

## Ansible Roles

### Role: common

**Purpose**: Basic system configuration for all servers

**Tasks** (`roles/common/tasks/main.yml`):

```yaml
---
- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Upgrade all packages
  apt:
    upgrade: dist
    autoremove: yes
    autoclean: yes

- name: Install essential packages
  apt:
    name:
      - vim
      - curl
      - wget
      - git
      - htop
      - net-tools
      - unzip
    state: present

- name: Create admin user
  user:
    name: "{{ admin_username }}"
    groups: sudo
    shell: /bin/bash
    create_home: yes

- name: Configure UFW firewall
  ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
  loop:
    - 22
    - 80
    - 443
```

**Variables** (`roles/common/defaults/main.yml`):

```yaml
---
admin_username: admin
timezone: UTC
```

### Role: nginx

**Purpose**: Install and configure Nginx web server

**Tasks** (`roles/nginx/tasks/main.yml`):

```yaml
---
- name: Install Nginx
  apt:
    name: nginx
    state: present

- name: Copy Nginx configuration
  template:
    src: nginx.conf.j2
    dest: /etc/nginx/sites-available/default
  notify: Restart Nginx

- name: Ensure Nginx is started and enabled
  service:
    name: nginx
    state: started
    enabled: yes

- name: Allow Nginx through firewall
  ufw:
    rule: allow
    name: 'Nginx Full'
```

**Template** (`roles/nginx/templates/nginx.conf.j2`):

```nginx
server {
    listen 80 default_server;
    listen [::]:80 default_server;

    root {{ nginx_root }};
    index index.html index.htm;

    server_name {{ nginx_server_name }};

    location / {
        try_files $uri $uri/ =404;
    }
}
```

**Handlers** (`roles/nginx/handlers/main.yml`):

```yaml
---
- name: Restart Nginx
  service:
    name: nginx
    state: restarted
```

### Role: docker

**Purpose**: Install Docker container runtime

**Tasks** (`roles/docker/tasks/main.yml`):

```yaml
---
- name: Install Docker dependencies
  apt:
    name:
      - apt-transport-https
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
    state: present

- name: Add Docker GPG key
  apt_key:
    url: https://download.docker.com/linux/ubuntu/gpg
    state: present

- name: Add Docker repository
  apt_repository:
    repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
    state: present

- name: Install Docker
  apt:
    name:
      - docker-ce
      - docker-ce-cli
      - containerd.io
      - docker-compose-plugin
    state: present
    update_cache: yes

- name: Add user to docker group
  user:
    name: "{{ ansible_user }}"
    groups: docker
    append: yes

- name: Start and enable Docker
  service:
    name: docker
    state: started
    enabled: yes
```

### Role: k8s-tools

**Purpose**: Install Kubernetes client tools

**Tasks** (`roles/k8s-tools/tasks/main.yml`):

```yaml
---
- name: Install kubectl
  get_url:
    url: "https://dl.k8s.io/release/{{ kubectl_version }}/bin/linux/amd64/kubectl"
    dest: /usr/local/bin/kubectl
    mode: '0755'

- name: Install Helm
  shell: |
    curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
  args:
    creates: /usr/local/bin/helm

- name: Verify kubectl installation
  command: kubectl version --client
  register: kubectl_version_output
  changed_when: false

- name: Verify Helm installation
  command: helm version
  register: helm_version_output
  changed_when: false
```

---

## Playbook Execution

### Basic Execution

```bash
# Run playbook
ansible-playbook -i inventory/hosts.ini setup.yml

# Dry run (check mode)
ansible-playbook -i inventory/hosts.ini setup.yml --check

# Verbose output
ansible-playbook -i inventory/hosts.ini setup.yml -v
ansible-playbook -i inventory/hosts.ini setup.yml -vv   # More verbose
ansible-playbook -i inventory/hosts.ini setup.yml -vvv  # Very verbose
```

### Targeted Execution

```bash
# Run only on web servers
ansible-playbook -i inventory/hosts.ini setup.yml --limit webservers

# Run specific role
ansible-playbook -i inventory/hosts.ini setup.yml --tags nginx

# Skip specific role
ansible-playbook -i inventory/hosts.ini setup.yml --skip-tags docker
```

### Ad-hoc Commands

```bash
# Ping all hosts
ansible all -i inventory/hosts.ini -m ping

# Check disk space
ansible all -i inventory/hosts.ini -m shell -a "df -h"

# Restart Nginx on web servers
ansible webservers -i inventory/hosts.ini -m service -a "name=nginx state=restarted" --become

# Get system info
ansible all -i inventory/hosts.ini -m setup
```

---

## Variables and Inventory

### Group Variables

**group_vars/all.yml** (applies to all hosts):

```yaml
---
# Common variables
timezone: UTC
ntp_servers:
  - 0.pool.ntp.org
  - 1.pool.ntp.org

# User configuration
admin_username: admin
```

**group_vars/webservers.yml** (applies to web servers):

```yaml
---
# Nginx configuration
nginx_root: /var/www/html
nginx_server_name: example.com
nginx_worker_processes: auto
```

### Host Variables

**host_vars/terraform-web-1.yml** (specific to one host):

```yaml
---
nginx_server_name: web1.example.com
```

### Variable Precedence

Ansible loads variables in this order (later overrides earlier):

1. Role defaults (`roles/*/defaults/main.yml`)
2. Inventory variables
3. Group variables (`group_vars/all.yml`)
4. Group variables (`group_vars/webservers.yml`)
5. Host variables (`host_vars/terraform-web-1.yml`)
6. Playbook variables
7. Extra variables (`-e` flag)

---

## Troubleshooting

### Connection Issues

**Problem**: Cannot connect to hosts

```bash
# Test SSH manually
ssh -i ~/.ssh/terraform-key ubuntu@<instance-ip>

# Check inventory
ansible-inventory -i inventory/hosts.ini --list

# Test ping
ansible all -i inventory/hosts.ini -m ping
```

### Permission Denied

**Problem**: Tasks fail with permission denied

**Solution**: Use `become: yes` in playbook or role

```yaml
- name: Install package
  apt:
    name: nginx
  become: yes  # Run with sudo
```

### Module Not Found

**Problem**: Module 'xyz' not found

**Solution**: Install required collection

```bash
ansible-galaxy collection install community.general
```

### Slow Execution

**Problem**: Playbook runs slowly

**Solutions**:

1. Enable pipelining in `ansible.cfg`:
```ini
[ssh_connection]
pipelining = True
```

2. Increase forks:
```ini
[defaults]
forks = 20
```

3. Disable fact gathering if not needed:
```yaml
- hosts: all
  gather_facts: no
```

---

## Best Practices

1. **Use Roles**: Organize tasks into reusable roles
2. **Idempotency**: Ensure tasks can run multiple times safely
3. **Variables**: Use variables for configurable values
4. **Handlers**: Use handlers for service restarts
5. **Tags**: Tag tasks for selective execution
6. **Check Mode**: Test with `--check` before applying
7. **Version Control**: Keep playbooks in Git
8. **Secrets**: Use Ansible Vault for sensitive data

---

[← Previous: Terraform Setup](03-terraform-setup.md) | [Next: Integration Workflow →](05-integration-workflow.md)
