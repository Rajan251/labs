version: '3.8'

services:
  # MongoDB Community Edition - Single instance with optimized settings
  # Uses collection-level separation (hot collections vs archive collections)
  mongo:
    image: mongo:5.0
    container_name: mongo
    volumes:
      - mongo_data:/data/db
      - mongo_config:/data/configdb
    ports:
      - "27017:27017"
    environment:
      - MONGO_INITDB_DATABASE=hot_cold_db
    command: >
      mongod --wiredTigerCacheSizeGB 2 --wiredTigerCollectionBlockCompressor snappy --wiredTigerJournalCompressor snappy --storageEngine wiredTiger
    restart: unless-stopped

  django:
    build:
      context: .
      dockerfile: docker/django/Dockerfile
    container_name: django
    command: /entrypoint.sh
    volumes:
      - ./backend/django_app:/app
      - ./backend/data_separation:/app/data_separation
      - ./backend/monitoring:/app/monitoring
      - static_volume:/app/static
    ports:
      - "8000:8000"
    environment:
      - DEBUG=1
      - DJANGO_SECRET_KEY=foo
      - DJANGO_ALLOWED_HOSTS=localhost 127.0.0.1 [::1]
      - MONGO_URI=mongodb://mongo:27017
      - MONGO_DB_NAME=hot_cold_db
      - HOT_MONGO_URI=mongodb://mongo:27017
      - HOT_DB_NAME=hot_cold_db
      - COLD_MONGO_URI=mongodb://mongo:27017
      - COLD_DB_NAME=hot_cold_db
      - DATABASE=mongodb
      - MONGO_HOST=mongo
      - MONGO_PORT=27017
    depends_on:
      - mongo
    restart: unless-stopped

  fastapi:
    build:
      context: .
      dockerfile: docker/fastapi/Dockerfile
    container_name: fastapi
    command: /entrypoint.sh
    volumes:
      - ./backend/fastapi_app:/app
      - ./backend/data_separation:/app/data_separation
      - ./backend/monitoring:/app/monitoring
      - ./backend/scripts:/app/scripts
    ports:
      - "8001:8000"
    environment:
      # MongoDB Community Edition - Same instance, different collections
      - HOT_MONGO_URI=mongodb://mongo:27017
      - HOT_DB_NAME=hot_cold_db
      - COLD_MONGO_URI=mongodb://mongo:27017
      - COLD_DB_NAME=hot_cold_db
      - DATABASE=mongodb
      - MONGO_HOST=mongo
      - MONGO_PORT=27017
      # Hot-Cold Configuration
      - HOT_THRESHOLD_DAYS=90
      - COLD_THRESHOLD_DAYS=90
      - MIGRATION_BATCH_SIZE=1000
      - SCHEDULER_ENABLED=True
      # Community Edition optimizations
      - USE_COMPRESSION=True
      - USE_INDEXES=True
    depends_on:
      - mongo
    restart: unless-stopped

  nginx:
    image: nginx:1.21-alpine
    container_name: nginx
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/conf.d/default.conf
      - static_volume:/app/static
    ports:
      - "80:80"
    depends_on:
      - django
      - fastapi
    restart: unless-stopped

volumes:
  mongo_data:
  mongo_config:
  static_volume:


