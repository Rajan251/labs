# Error Rate Alert Rules
# Alerts for HTTP error rates and SLO breaches

groups:
  - name: error_rate
    interval: 30s
    rules:
      # Critical: High error rate (>5%)
      - alert: HighErrorRate
        expr: |
          sum(rate(http_requests_total{status=~"5.."}[5m])) by (job, service)
          /
          sum(rate(http_requests_total[5m])) by (job, service)
          > 0.05
        for: 5m
        labels:
          severity: page
          team: backend
        annotations:
          summary: "High error rate on {{ $labels.service }}"
          description: "Service {{ $labels.service }} has {{ $value | humanizePercentage }} error rate over the last 5 minutes."
          impact: "Significant user-facing errors"
          runbook_url: "https://runbooks.example.com/high-error-rate"
          dashboard_url: "http://localhost:3000/d/service-overview?var-service={{ $labels.service }}"

      # Warning: Elevated error rate (>2%)
      - alert: ElevatedErrorRate
        expr: |
          sum(rate(http_requests_total{status=~"5.."}[5m])) by (job, service)
          /
          sum(rate(http_requests_total[5m])) by (job, service)
          > 0.02
        for: 10m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: "Elevated error rate on {{ $labels.service }}"
          description: "Service {{ $labels.service }} has {{ $value | humanizePercentage }} error rate over the last 10 minutes."
          impact: "Increased error rate, monitoring required"
          runbook_url: "https://runbooks.example.com/elevated-error-rate"

      # Critical: 4xx error rate spike (client errors)
      - alert: HighClientErrorRate
        expr: |
          sum(rate(http_requests_total{status=~"4.."}[5m])) by (job, service)
          /
          sum(rate(http_requests_total[5m])) by (job, service)
          > 0.20
        for: 10m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: "High 4xx error rate on {{ $labels.service }}"
          description: "Service {{ $labels.service }} has {{ $value | humanizePercentage }} 4xx error rate. Possible API misuse or breaking change."
          impact: "High client error rate - investigate API changes"
          runbook_url: "https://runbooks.example.com/high-4xx-rate"

      # Critical: SLO error budget burn rate (fast)
      - alert: ErrorBudgetBurnRateFast
        expr: |
          (
            sum(rate(http_requests_total{status=~"5.."}[1h])) by (service)
            /
            sum(rate(http_requests_total[1h])) by (service)
          ) > (14.4 * (1 - 0.999))
        for: 5m
        labels:
          severity: page
          team: sre
        annotations:
          summary: "Fast error budget burn on {{ $labels.service }}"
          description: "Service {{ $labels.service }} is burning through error budget at 14.4x the acceptable rate. At this rate, the monthly error budget will be exhausted in 2 days."
          impact: "SLO breach imminent - immediate action required"
          runbook_url: "https://runbooks.example.com/error-budget-burn"
          dashboard_url: "http://localhost:3000/d/slo-tracking?var-service={{ $labels.service }}"

      # Warning: SLO error budget burn rate (slow)
      - alert: ErrorBudgetBurnRateSlow
        expr: |
          (
            sum(rate(http_requests_total{status=~"5.."}[6h])) by (service)
            /
            sum(rate(http_requests_total[6h])) by (service)
          ) > (6 * (1 - 0.999))
        for: 30m
        labels:
          severity: warning
          team: sre
        annotations:
          summary: "Slow error budget burn on {{ $labels.service }}"
          description: "Service {{ $labels.service }} is burning through error budget at 6x the acceptable rate over the last 6 hours."
          impact: "SLO at risk - investigation recommended"
          runbook_url: "https://runbooks.example.com/error-budget-burn"

      # Critical: No requests (possible monitoring gap)
      - alert: NoRequests
        expr: |
          sum(rate(http_requests_total[5m])) by (job, service) == 0
        for: 10m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "No requests to {{ $labels.service }}"
          description: "Service {{ $labels.service }} has received no requests in the last 10 minutes. Possible service down or monitoring issue."
          impact: "No traffic - investigate if expected"
          runbook_url: "https://runbooks.example.com/no-requests"

      # Critical: Error rate spike (sudden increase)
      - alert: ErrorRateSpike
        expr: |
          (
            sum(rate(http_requests_total{status=~"5.."}[5m])) by (service)
            /
            sum(rate(http_requests_total[5m])) by (service)
          )
          /
          (
            sum(rate(http_requests_total{status=~"5.."}[1h] offset 1h)) by (service)
            /
            sum(rate(http_requests_total[1h] offset 1h)) by (service)
          ) > 5
        for: 5m
        labels:
          severity: critical
          team: backend
        annotations:
          summary: "Error rate spike on {{ $labels.service }}"
          description: "Service {{ $labels.service }} error rate is {{ $value }}x higher than 1 hour ago."
          impact: "Sudden error rate increase - possible deployment or dependency issue"
          runbook_url: "https://runbooks.example.com/error-spike"

      # Warning: Specific endpoint errors
      - alert: EndpointErrors
        expr: |
          sum(rate(http_requests_total{status=~"5..", path!=""}[5m])) by (service, path)
          /
          sum(rate(http_requests_total{path!=""}[5m])) by (service, path)
          > 0.10
        for: 5m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: "High error rate on {{ $labels.service }}{{ $labels.path }}"
          description: "Endpoint {{ $labels.path }} on {{ $labels.service }} has {{ $value | humanizePercentage }} error rate."
          impact: "Specific endpoint experiencing errors"
          runbook_url: "https://runbooks.example.com/endpoint-errors"
