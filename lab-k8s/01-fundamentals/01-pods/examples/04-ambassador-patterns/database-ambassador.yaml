# Ambassador Pattern - Database Proxy
# Ambassador container acts as a proxy to external services

apiVersion: v1
kind: Pod
metadata:
  name: app-with-db-ambassador
  labels:
    app: webapp
    pattern: ambassador
  annotations:
    description: "Application with database ambassador/proxy sidecar"
spec:
  containers:
  
  # Main application container
  - name: webapp
    image: myapp:1.0.0
    ports:
    - containerPort: 8080
      name: http
    env:
    # Application connects to localhost (ambassador handles the actual connection)
    - name: DATABASE_HOST
      value: "localhost"
    - name: DATABASE_PORT
      value: "5432"
    - name: DATABASE_NAME
      value: "mydb"
    - name: DATABASE_USER
      valueFrom:
        secretKeyRef:
          name: db-credentials
          key: username
    - name: DATABASE_PASSWORD
      valueFrom:
        secretKeyRef:
          name: db-credentials
          key: password
    resources:
      requests:
        memory: "256Mi"
        cpu: "200m"
      limits:
        memory: "512Mi"
        cpu: "400m"
  
  # Ambassador: Cloud SQL Proxy (for Google Cloud)
  - name: cloudsql-proxy
    image: gcr.io/cloudsql-docker/gce-proxy:1.33.0
    command:
    - "/cloud_sql_proxy"
    - "-instances=my-project:us-central1:my-instance=tcp:5432"
    - "-credential_file=/secrets/service_account.json"
    securityContext:
      runAsNonRoot: true
      runAsUser: 65532
    volumeMounts:
    - name: cloudsql-credentials
      mountPath: /secrets
      readOnly: true
    resources:
      requests:
        memory: "64Mi"
        cpu: "50m"
      limits:
        memory: "128Mi"
        cpu: "100m"
  
  volumes:
  - name: cloudsql-credentials
    secret:
      secretName: cloudsql-service-account

---
# Alternative: Generic TCP Proxy Ambassador
apiVersion: v1
kind: Pod
metadata:
  name: app-with-tcp-proxy
  labels:
    app: webapp
    pattern: tcp-proxy-ambassador
spec:
  containers:
  
  # Main application
  - name: app
    image: myapp:1.0.0
    env:
    # Connect to localhost - ambassador handles routing
    - name: REDIS_HOST
      value: "localhost"
    - name: REDIS_PORT
      value: "6379"
    resources:
      requests:
        memory: "256Mi"
        cpu: "200m"
      limits:
        memory: "512Mi"
        cpu: "400m"
  
  # Ambassador: HAProxy for connection pooling and load balancing
  - name: haproxy
    image: haproxy:2.8-alpine
    ports:
    - containerPort: 6379
      name: redis-proxy
    volumeMounts:
    - name: haproxy-config
      mountPath: /usr/local/etc/haproxy
    resources:
      requests:
        memory: "64Mi"
        cpu: "50m"
      limits:
        memory: "128Mi"
        cpu: "100m"
  
  volumes:
  - name: haproxy-config
    configMap:
      name: haproxy-config

---
# ConfigMap for HAProxy configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: haproxy-config
data:
  haproxy.cfg: |
    global
        maxconn 256
        log stdout format raw local0
    
    defaults
        mode tcp
        timeout connect 5000ms
        timeout client 50000ms
        timeout server 50000ms
        log global
    
    frontend redis-frontend
        bind *:6379
        default_backend redis-backend
    
    backend redis-backend
        balance roundrobin
        # Multiple Redis servers for HA
        server redis1 redis-master.default.svc.cluster.local:6379 check
        server redis2 redis-replica-1.default.svc.cluster.local:6379 check backup
        server redis3 redis-replica-2.default.svc.cluster.local:6379 check backup

---
# Example: Ambassador for rate limiting
apiVersion: v1
kind: Pod
metadata:
  name: app-with-rate-limit-ambassador
  labels:
    app: api
    pattern: rate-limit-ambassador
spec:
  containers:
  
  # Main API application
  - name: api
    image: myapi:1.0.0
    ports:
    - containerPort: 8080
    env:
    # API calls external service via ambassador
    - name: EXTERNAL_API_URL
      value: "http://localhost:8081"
    resources:
      requests:
        memory: "256Mi"
        cpu: "200m"
      limits:
        memory: "512Mi"
        cpu: "400m"
  
  # Ambassador: Envoy proxy with rate limiting
  - name: envoy
    image: envoyproxy/envoy:v1.27-latest
    ports:
    - containerPort: 8081
      name: proxy
    - containerPort: 9901
      name: admin
    volumeMounts:
    - name: envoy-config
      mountPath: /etc/envoy
    command:
    - "envoy"
    - "-c"
    - "/etc/envoy/envoy.yaml"
    resources:
      requests:
        memory: "128Mi"
        cpu: "100m"
      limits:
        memory: "256Mi"
        cpu: "200m"
  
  volumes:
  - name: envoy-config
    configMap:
      name: envoy-rate-limit-config

---
# ConfigMap for Envoy with rate limiting
apiVersion: v1
kind: ConfigMap
metadata:
  name: envoy-rate-limit-config
data:
  envoy.yaml: |
    admin:
      address:
        socket_address:
          address: 0.0.0.0
          port_value: 9901
    
    static_resources:
      listeners:
      - name: listener_0
        address:
          socket_address:
            address: 0.0.0.0
            port_value: 8081
        filter_chains:
        - filters:
          - name: envoy.filters.network.http_connection_manager
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
              stat_prefix: ingress_http
              route_config:
                name: local_route
                virtual_hosts:
                - name: backend
                  domains: ["*"]
                  routes:
                  - match:
                      prefix: "/"
                    route:
                      cluster: external_api
                  rate_limits:
                  - actions:
                    - generic_key:
                        descriptor_value: "default"
              http_filters:
              - name: envoy.filters.http.local_ratelimit
                typed_config:
                  "@type": type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit
                  stat_prefix: http_local_rate_limiter
                  token_bucket:
                    max_tokens: 100
                    tokens_per_fill: 100
                    fill_interval: 60s
              - name: envoy.filters.http.router
      
      clusters:
      - name: external_api
        connect_timeout: 5s
        type: STRICT_DNS
        lb_policy: ROUND_ROBIN
        load_assignment:
          cluster_name: external_api
          endpoints:
          - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: external-api.example.com
                    port_value: 443
        transport_socket:
          name: envoy.transport_sockets.tls
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
